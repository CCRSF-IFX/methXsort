name: Test Simulation Pipeline

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  test-simulation-xengsort:
    name: Test xengsort simulation workflow
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget curl gzip
        
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -e .
        
    - name: Verify methXsort installation
      run: |
        echo "Testing methXsort installation..."
        methXsort --version
        methXsort --help
        python -c "from methxsort import core; print('✓ Package imported successfully')"
        
    - name: Install Sherman (bisulfite read simulator)
      run: |
        echo "Installing Sherman v0.1.8..."
        mkdir -p tools
        cd tools
        wget https://www.bioinformatics.babraham.ac.uk/projects/sherman/Sherman_v0.1.8.zip
        unzip Sherman_v0.1.8.zip
        chmod +x Sherman
        cd ..
        echo "Sherman installed at: $(pwd)/tools/Sherman"
        ./tools/Sherman --version || echo "Sherman installed (no --version flag)"
        
    - name: Install xengsort
      run: |
        echo "Installing xengsort..."
        pip install xengsort
        xengsort --version
        
    - name: Prepare test data (small reference genomes)
      run: |
        echo "Preparing small test reference genomes..."
        mkdir -p test_simulation/output
        
        # Extract first 10kb from E. coli (host) for fast testing
        echo "Extracting first 10kb from data/ecoli.fa..."
        cat data/ecoli.fa > test_simulation/host.fa
        LINES=$(wc -l < test_simulation/host.fa)
        echo "Created host reference from E. coli ($LINES lines)"
        
        # Extract first 10kb from EHEC (graft) for fast testing
        echo "Extracting first 10kb from data/ehec.fa..."
        cat data/ehec.fa > test_simulation/graft.fa
        LINES=$(wc -l < test_simulation/graft.fa)
        echo "Created graft reference from EHEC ($LINES lines)"
        
        echo ""
        echo "Test reference files created:"
        ls -lh test_simulation/*.fa
        echo ""
        echo "Host reference info:"
        head -n 1 test_simulation/host.fa
        echo "Graft reference info:"
        head -n 1 test_simulation/graft.fa
        
    - name: Test methXsort commands individually
      run: |
        echo "======================================"
        echo "Testing individual methXsort commands"
        echo "======================================"
        echo ""
        
        # Test 1: Reference conversion
        echo "1. Testing convert-ref..."
        methXsort convert-ref test_simulation/host.fa -o test_simulation/output/host_cvt.fa
        methXsort convert-ref test_simulation/graft.fa -o test_simulation/output/graft_cvt.fa
        echo "✓ Reference conversion successful"
        echo ""
        
        # Test 2: Verify converted references exist
        ls -lh test_simulation/output/*_cvt.fa
        echo ""
        
    - name: Run Sherman simulation
      run: |
        echo "======================================"
        echo "Running Sherman bisulfite simulation"
        echo "======================================"
        echo ""
        
        WORKSPACE=$(pwd)
        mkdir -p test_simulation/output/graft test_simulation/output/host test_simulation/output/sim_reads
        
        # Link references for Sherman
        ln -sf $WORKSPACE/test_simulation/graft.fa test_simulation/output/graft/graft.fa
        ln -sf $WORKSPACE/test_simulation/host.fa test_simulation/output/host/host.fa
        
        # Run Sherman for graft (500 read pairs)
        echo "Simulating graft reads..."
        cd test_simulation/output/graft
        $WORKSPACE/tools/Sherman --conversion_rate 60 -l 150 -n 500 --genome_folder . -pe > sherman.log 2>&1
        cd $WORKSPACE
        
        # Run Sherman for host (500 read pairs)
        echo "Simulating host reads..."
        cd test_simulation/output/host
        $WORKSPACE/tools/Sherman --conversion_rate 60 -l 150 -n 500 --genome_folder . -pe > sherman.log 2>&1
        cd $WORKSPACE
        
        # Add labels to read IDs and compress
        echo "Processing simulated reads..."
        cat test_simulation/output/graft/simulated_1.fastq | sed '1~4s/^@\([0-9][0-9]*_\)/@\1graft_/' | gzip -c > test_simulation/output/sim_reads/simulated_bs_graft_R1.fastq.gz
        cat test_simulation/output/graft/simulated_2.fastq | sed '1~4s/^@\([0-9][0-9]*_\)/@\1graft_/' | gzip -c > test_simulation/output/sim_reads/simulated_bs_graft_R2.fastq.gz
        cat test_simulation/output/host/simulated_1.fastq | sed '1~4s/^@\([0-9][0-9]*_\)/@\1host_/' | gzip -c > test_simulation/output/sim_reads/simulated_bs_host_R1.fastq.gz
        cat test_simulation/output/host/simulated_2.fastq | sed '1~4s/^@\([0-9][0-9]*_\)/@\1host_/' | gzip -c > test_simulation/output/sim_reads/simulated_bs_host_R2.fastq.gz
        
        echo "✓ Sherman simulation complete"
        ls -lh test_simulation/output/sim_reads/*.fastq.gz
        echo ""
        
    - name: Merge and convert reads
      run: |
        echo "======================================"
        echo "Merging and converting reads"
        echo "======================================"
        echo ""
        
        # Merge graft and host reads
        cat test_simulation/output/sim_reads/simulated_bs_graft_R1.fastq.gz test_simulation/output/sim_reads/simulated_bs_host_R1.fastq.gz > test_simulation/output/sim_reads/merged_simulated_bs_R1.fastq.gz
        cat test_simulation/output/sim_reads/simulated_bs_graft_R2.fastq.gz test_simulation/output/sim_reads/simulated_bs_host_R2.fastq.gz > test_simulation/output/sim_reads/merged_simulated_bs_R2.fastq.gz
        echo "✓ Reads merged"
        
        # Convert reads (C→T, G→A) while preserving original sequence
        echo "Converting reads (C→T, G→A)..."
        methXsort convert-reads --with_orig_seq \
          --read test_simulation/output/sim_reads/merged_simulated_bs_R1.fastq.gz \
          --read2 test_simulation/output/sim_reads/merged_simulated_bs_R2.fastq.gz \
          --out test_simulation/output/sim_reads/merged_simulated_bscvt_R1.fastq.gz \
          --out2 test_simulation/output/sim_reads/merged_simulated_bscvt_R2.fastq.gz
        
        echo "✓ Reads converted"
        ls -lh test_simulation/output/sim_reads/merged_*.fastq.gz
        echo ""
        
    - name: Build xengsort index
      run: |
        echo "======================================"
        echo "Building xengsort index"
        echo "======================================"
        echo ""
        
        mkdir -p test_simulation/output/ref_idx
        
        methXsort xengsort-index \
          --host test_simulation/output/host_cvt.fa \
          --graft test_simulation/output/graft_cvt.fa \
          --index test_simulation/output/ref_idx/xengsort_index \
          -n 20_000_000 --fill 0.88 --statistics summary -k 25 \
          > test_simulation/output/ref_idx/xengsort_index.log 2>&1
        
        echo "✓ xengsort index built"
        ls -lh test_simulation/output/ref_idx/
        echo ""
        echo "Index log (first 20 lines):"
        head -20 test_simulation/output/ref_idx/xengsort_index.log
        echo ""
        
    - name: Classify reads with xengsort
      run: |
        echo "======================================"
        echo "Classifying reads with xengsort"
        echo "======================================"
        echo ""
        
        mkdir -p test_simulation/output/xengsort_classify
        
        methXsort xengsort-classify \
          --read test_simulation/output/sim_reads/merged_simulated_bscvt_R1.fastq.gz \
          --read2 test_simulation/output/sim_reads/merged_simulated_bscvt_R2.fastq.gz \
          --index test_simulation/output/ref_idx/xengsort_index \
          --out_prefix test_simulation/output/xengsort_classify/xengsort_classify \
          --threads 2 \
          > test_simulation/output/classify.log 2>&1
        
        echo "✓ Reads classified"
        ls -lh test_simulation/output/xengsort_classify/
        echo ""
        
    - name: Restore original FASTQ sequences
      run: |
        echo "======================================"
        echo "Restoring original FASTQ sequences"
        echo "======================================"
        echo ""
        
        mkdir -p test_simulation/output/fastq
        
        # Restore graft reads
        echo "Restoring graft reads..."
        methXsort restore-fastq \
          --read test_simulation/output/xengsort_classify/xengsort_classify-graft.1.fq.gz \
          --read2 test_simulation/output/xengsort_classify/xengsort_classify-graft.2.fq.gz \
          --out test_simulation/output/fastq/restored_graft_R1.fastq.gz \
          --out2 test_simulation/output/fastq/restored_graft_R2.fastq.gz
        
        # Restore host reads
        echo "Restoring host reads..."
        methXsort restore-fastq \
          --read test_simulation/output/xengsort_classify/xengsort_classify-host.1.fq.gz \
          --read2 test_simulation/output/xengsort_classify/xengsort_classify-host.2.fq.gz \
          --out test_simulation/output/fastq/restored_host_R1.fastq.gz \
          --out2 test_simulation/output/fastq/restored_host_R2.fastq.gz
        
        echo "✓ FASTQ sequences restored"
        ls -lh test_simulation/output/fastq/
        echo ""
        
    - name: Generate statistics
      run: |
        echo "======================================"
        echo "Generating statistics"
        echo "======================================"
        echo ""
        
        methXsort stat-split \
          --raw test_simulation/output/sim_reads/merged_simulated_bscvt_R1.fastq.gz \
          --graft test_simulation/output/fastq/restored_graft_R1.fastq.gz \
          --host test_simulation/output/fastq/restored_host_R1.fastq.gz \
          --xengsort_prefix test_simulation/output/xengsort_classify/xengsort_classify \
          --sample_name "ci_test_simulation" \
          > test_simulation/output/read_number_stat.txt
        
        echo "✓ Statistics generated"
        echo ""
        echo "======================================"
        echo "READ STATISTICS"
        echo "======================================"
        cat test_simulation/output/read_number_stat.txt
        echo ""
        
    - name: Verify all outputs
      run: |
        echo "======================================"
        echo "Verifying all pipeline outputs"
        echo "======================================"
        echo ""
        
        EXIT_CODE=0
        
        # Check converted references
        if [ -f test_simulation/output/host_cvt.fa ]; then
          echo "✓ Converted host reference"
        else
          echo "✗ Missing: converted host reference"
          EXIT_CODE=1
        fi
        
        if [ -f test_simulation/output/graft_cvt.fa ]; then
          echo "✓ Converted graft reference"
        else
          echo "✗ Missing: converted graft reference"
          EXIT_CODE=1
        fi
        
        # Check Sherman outputs
        if [ -f test_simulation/output/sim_reads/simulated_bs_graft_R1.fastq.gz ]; then
          echo "✓ Sherman graft reads"
        else
          echo "✗ Missing: Sherman graft reads"
          EXIT_CODE=1
        fi
        
        if [ -f test_simulation/output/sim_reads/simulated_bs_host_R1.fastq.gz ]; then
          echo "✓ Sherman host reads"
        else
          echo "✗ Missing: Sherman host reads"
          EXIT_CODE=1
        fi
        
        # Check merged and converted reads
        if [ -f test_simulation/output/sim_reads/merged_simulated_bscvt_R1.fastq.gz ]; then
          echo "✓ Merged and converted reads"
        else
          echo "✗ Missing: merged and converted reads"
          EXIT_CODE=1
        fi
        
        # Check xengsort index
        if [ -f test_simulation/output/ref_idx/xengsort_index.log ]; then
          echo "✓ xengsort index"
        else
          echo "✗ Missing: xengsort index"
          EXIT_CODE=1
        fi
        
        # Check xengsort classification
        if [ -f test_simulation/output/xengsort_classify/xengsort_classify-graft.1.fq.gz ]; then
          echo "✓ xengsort classified graft reads"
        else
          echo "✗ Missing: xengsort classified graft reads"
          EXIT_CODE=1
        fi
        
        if [ -f test_simulation/output/xengsort_classify/xengsort_classify-host.1.fq.gz ]; then
          echo "✓ xengsort classified host reads"
        else
          echo "✗ Missing: xengsort classified host reads"
          EXIT_CODE=1
        fi
        
        # Check restored FASTQs
        if [ -f test_simulation/output/fastq/restored_graft_R1.fastq.gz ]; then
          echo "✓ Restored graft FASTQ"
        else
          echo "✗ Missing: restored graft FASTQ"
          EXIT_CODE=1
        fi
        
        if [ -f test_simulation/output/fastq/restored_host_R1.fastq.gz ]; then
          echo "✓ Restored host FASTQ"
        else
          echo "✗ Missing: restored host FASTQ"
          EXIT_CODE=1
        fi
        
        # Check statistics
        if [ -f test_simulation/output/read_number_stat.txt ]; then
          echo "✓ Read statistics"
        else
          echo "✗ Missing: read statistics"
          EXIT_CODE=1
        fi
        
        echo ""
        if [ $EXIT_CODE -eq 0 ]; then
          echo "✅ All outputs verified successfully!"
        else
          echo "❌ Some outputs are missing!"
          echo ""
          echo "=== Directory structure ==="
          find test_simulation/output -type f 2>/dev/null | sort || echo "No output files found"
          exit $EXIT_CODE
        fi
        
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: simulation-test-results
        path: |
          test_simulation/output/
          test_simulation/*.fa
        retention-days: 7
        
    - name: Test summary
      if: always()
      run: |
        echo ""
        echo "=========================================================="
        echo "         SIMULATION PIPELINE TEST SUMMARY"
        echo "=========================================================="
        echo ""
        echo "✓ methXsort package installed and verified"
        echo "✓ Sherman bisulfite simulator installed"
        echo "✓ xengsort read classifier installed"
        echo ""
        echo "Pipeline Steps Completed:"
        echo "  1. ✓ Reference conversion (C→T, G→A)"
        echo "  2. ✓ Sherman read simulation (500 read pairs × 2)"
        echo "  3. ✓ Read merging and labeling"
        echo "  4. ✓ Read conversion (C→T, G→A)"
        echo "  5. ✓ xengsort index building"
        echo "  6. ✓ xengsort classification (host vs graft)"
        echo "  7. ✓ FASTQ restoration (original sequences)"
        echo "  8. ✓ Statistics generation"
        echo ""
        echo "All methXsort subcommands tested:"
        echo "  • methXsort convert-ref"
        echo "  • methXsort convert-reads"
        echo "  • methXsort xengsort-index"
        echo "  • methXsort xengsort-classify"
        echo "  • methXsort restore-fastq"
        echo "  • methXsort stat-split"
        echo ""
        echo "See uploaded artifacts for detailed results"
        echo "=========================================================="
