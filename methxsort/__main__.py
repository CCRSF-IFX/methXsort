#!/usr/bin/env python3
"""
methXsort command-line interface
"""

import argparse
import sys
import subprocess

from .core import (
    convert_fasta,
    convert_reads_c2t_r1_g2a_r2,
    filter_fastq_by_bam,
    run_bbsplit,
    build_bbsplit_index,
    ensure_bbsplit_index_structure,
    stat_split,
    filter_xengsort_extra,
    run_xengsort_classify,
    restore_fastq_from_xengsort,
    parse_xengsort_summary_table,
)
from . import __version__


def main():
    """Main entry point for methXsort CLI"""
    parser = argparse.ArgumentParser(
        description="Sort reads into host and graft categories",
        prog="methxsort"
    )
    parser.add_argument('--version', action='version', version=f'%(prog)s {__version__}')
    subparsers = parser.add_subparsers(dest="command", required=True)

    # Subcommand 1: convert-ref
    parser_ref = subparsers.add_parser("convert-ref", help="Convert reference genome C->T (fwd) and G->A (rev)")
    parser_ref.add_argument("ref_fasta", help="Reference FASTA file")
    parser_ref.add_argument("-o", "--output", help="Output FASTA file (default: <ref_fasta>.c2t)")

    # Subcommand 2: convert-reads
    parser_reads = subparsers.add_parser("convert-reads", help="Convert C->T in read and G->A in read2 (if paired)")
    parser_reads.add_argument("--read", required=True, help="FASTQ file for read (single or read1)")
    parser_reads.add_argument("--read2", help="FASTQ file for read 2 (optional)")
    parser_reads.add_argument("--out", help="Output file for converted read")
    parser_reads.add_argument("--out2", help="Output file for converted read 2")

    # Create mutually exclusive group for --with_orig_seq and --without_orig_seq
    seq_group = parser_reads.add_mutually_exclusive_group()
    seq_group.add_argument("--without_orig_seq", action="store_true",
        help="Do not include the original sequence in the FASTQ header (faster)")
    seq_group.add_argument("--with_orig_seq", action="store_true", default=True,
        help="Include the original sequence in the FASTQ header using awk (slower, but preserves original sequence) [default]")

    # Subcommand 3: filter-fastq-by-bam
    parser_bam2fq = subparsers.add_parser("filter-fastq-by-bam", help="Convert BAM to FASTQ using filterbyname.sh and raw reads")
    parser_bam2fq.add_argument("--read", required=True, help="Raw FASTQ file for read 1")
    parser_bam2fq.add_argument("--read2", help="Raw FASTQ file for read 2 (optional)")
    parser_bam2fq.add_argument("--bam", required=True, help="Input BAM file generated by bbsplit")
    parser_bam2fq.add_argument("--out", help="Output FASTQ file for read 1 (can be .gz)")
    parser_bam2fq.add_argument("--out2", help="Output FASTQ file for read 2 (can be .gz, optional)")
    parser_bam2fq.add_argument("--filterbyname_path", default="filterbyname.sh", help="Path to filterbyname.sh (or splitbyname.sh)")

    # Subcommand 4: bbsplit
    parser_bbsplit = subparsers.add_parser("bbsplit", help="Invoke bbsplit.sh to split reads and convert to BAM")
    parser_bbsplit.add_argument("--read", required=True, help="FASTQ file for read 1")
    parser_bbsplit.add_argument("--read2", help="FASTQ file for read 2 (optional)")
    parser_bbsplit.add_argument("--host", required=True, help="Reference genome name for host")
    parser_bbsplit.add_argument("--graft", required=True, help="Reference genome name for graft")
    parser_bbsplit.add_argument("--out_host", required=True, help="Output BAM file for host")
    parser_bbsplit.add_argument("--out_graft", required=True, help="Output BAM file for graft")
    parser_bbsplit.add_argument("--bbsplit_path", default="bbsplit.sh", help="Path to bbsplit.sh")
    parser_bbsplit.add_argument("--bbsplit_extra", 
                                default="ambiguous=best ambiguous2=split", 
                                help="Extra parameters for bbsplit.sh")
    parser_bbsplit.add_argument("--bbsplit_index_build", default=1, help="bbsplit index build (default: 1)")
    parser_bbsplit.add_argument("--bbsplit_index_path", default="bbsplit_index", help="bbsplit index path (default: bbsplit_index)")

    # Subcommand 5: bbsplit-index
    parser_bbsplit_build = subparsers.add_parser("bbsplit-index", help="Build bbsplit index from converted reference FASTA files")
    parser_bbsplit_build.add_argument("--host", required=True, help="Converted host reference FASTA file")
    parser_bbsplit_build.add_argument("--graft", required=True, help="Converted graft reference FASTA file")
    parser_bbsplit_build.add_argument("--host_name", required=True, help="Name for host reference (e.g. mm)")
    parser_bbsplit_build.add_argument("--graft_name", required=True, help="Name for graft reference (e.g. hs)")
    parser_bbsplit_build.add_argument("--bbsplit_path", default="bbsplit.sh", help="Path to bbsplit.sh")
    parser_bbsplit_build.add_argument("--bbsplit_index_path", default="bbsplit_idx_convert", help="bbsplit index directory")
    parser_bbsplit_build.add_argument("--bbsplit_index_build", default="1", help="Build number for bbsplit index (default: 1)")

    # Subcommand: stat-split
    parser_stat_split = subparsers.add_parser("stat-split", help="Output split statistics as CSV")
    parser_stat_split.add_argument("--raw", required=True, help="Raw FASTQ file (R1)")
    parser_stat_split.add_argument("--host", required=True, help="Host FASTQ file (R1)")
    parser_stat_split.add_argument("--graft", required=True, help="Graft FASTQ file (R1)")
    parser_stat_split.add_argument("--sample_name", required=True, help="Sample name for statistics")
    parser_stat_split.add_argument("--xengsort_prefix", help="Prefix for xengsort output files (optional)")

    # Subcommand: xengsort-index
    parser_xengsort_index = subparsers.add_parser("xengsort-index", help="Build xengsort index from converted reference FASTA files")
    parser_xengsort_index.add_argument("--host", required=True, help="Converted host reference FASTA file")
    parser_xengsort_index.add_argument("--graft", required=True, help="Converted graft reference FASTA file")
    parser_xengsort_index.add_argument("--index", required=True, help="Output xengsort index directory")
    parser_xengsort_index.add_argument("-n", default="7000000000", help="Number of slots in hash table (default: 7_000_000_000)")
    parser_xengsort_index.add_argument("--fill", default="0.88", help="Fill factor (default: 0.88)")
    parser_xengsort_index.add_argument("--statistics", default="full", help="Statistics level (default: full)")
    parser_xengsort_index.add_argument("-k", default="25", help="k-mer size (default: 25)")
    parser_xengsort_index.add_argument("--xengsort_path", default="xengsort", help="Path to xengsort executable")
    parser_xengsort_index.add_argument("--xengsort_extra", default="", help="Extra parameters for xengsort index command")

    # Subcommand: xengsort-classify
    parser_xengsort_classify = subparsers.add_parser("xengsort-classify", help="Classify reads using xengsort")
    parser_xengsort_classify.add_argument("--read", required=True, help="FASTQ file (read 1)")
    parser_xengsort_classify.add_argument("--read2", help="FASTQ file (read 2, optional)")
    parser_xengsort_classify.add_argument("--index", required=True, help="xengsort index directory")
    parser_xengsort_classify.add_argument("--out_prefix", required=True, help="Output prefix for xengsort results")
    parser_xengsort_classify.add_argument("--threads", default="1", help="Number of threads to use")
    parser_xengsort_classify.add_argument("--xengsort_path", default="xengsort", help="Path to xengsort executable")
    parser_xengsort_classify.add_argument("--xengsort_extra", default="", help="Extra parameters for xengsort classify command")
    
    # Subcommand: restore-fastq
    parser_restore = subparsers.add_parser("restore-fastq", help="Restore original sequences in FASTQ files classified by xengsort")
    parser_restore.add_argument("--read", required=True, help="Input FASTQ file with ORIGINAL_SEQ in header (read 1)")
    parser_restore.add_argument("--out", required=True, help="Output FASTQ file with restored sequences (read 1)")
    parser_restore.add_argument("--read2", help="Input FASTQ file with ORIGINAL_SEQ in header (read 2, optional)")
    parser_restore.add_argument("--out2", help="Output FASTQ file with restored sequences (read 2, optional)")

    # Subcommand: parse-xengsort-summary
    parser_xengsort_summary = subparsers.add_parser("parse-xengsort-summary", help="Parse xengsort summary and output classification statistics as CSV")
    parser_xengsort_summary.add_argument("--xengsort_summary", required=True, help="xengsort summary file")
    parser_xengsort_summary.add_argument("--outfile", required=True, help="Output CSV file")

    # Subcommand: parse-xengsort-log-table
    parser_xengsort_log_table = subparsers.add_parser("parse-xengsort-log-table", help="Parse xengsort log vertical table and output as CSV")
    parser_xengsort_log_table.add_argument("--logfile", required=True, help="xengsort log file")
    parser_xengsort_log_table.add_argument("--outfile", required=True, help="Output CSV file")

    args = parser.parse_args()

    if args.command == "convert-ref":
        out_fa = args.output if args.output else args.ref_fasta + ".c2t"
        out_fa = convert_fasta(args.ref_fasta, out_fa=out_fa)
        print(out_fa)
    elif args.command == "convert-reads":
        out = args.out if args.out else args.read + ".meth"
        out2 = args.out2 if args.read2 and args.out2 else (args.read2 + ".meth" if args.read2 else None)
        convert_reads_c2t_r1_g2a_r2(args.read, args.read2, out, out2, with_orig_seq=not args.without_orig_seq)
    elif args.command == "filter-fastq-by-bam":
        filter_fastq_by_bam(
            read=args.read, read2=args.read2,
            bamfile=args.bam, 
            out=args.out, out2=args.out2,
            filterbyname_path=args.filterbyname_path
        )
    elif args.command == "bbsplit":
        ensure_bbsplit_index_structure(
            args.bbsplit_index_path, args.bbsplit_index_build, host=args.host, graft=args.graft
        )
        run_bbsplit(
            args.read, args.read2, args.host, args.graft,
            args.out_host, args.out_graft,
            bbsplit_path=args.bbsplit_path,
            bbsplit_extra=args.bbsplit_extra,
            bbsplit_index_build=args.bbsplit_index_build,
            bbsplit_index_path=args.bbsplit_index_path
        )
    elif args.command == "bbsplit-index":
        build_bbsplit_index(
            host_fa=args.host,
            graft_fa=args.graft,
            host_name=args.host_name,
            graft_name=args.graft_name,
            bbsplit_idx_dir=args.bbsplit_index_path,
            bbsplit_path=args.bbsplit_path,
            build=args.bbsplit_index_build
        )
    elif args.command == "stat-split":
        stat_split(args.raw, 
                   args.host, 
                   args.graft, 
                   getattr(args, "xengsort_prefix", None), 
                   sample_name=args.sample_name)
    elif args.command == "xengsort-index":
        used_params = [
            "-H", "--host", "-G", "--graft", "-n", "--nobjects", "--fill", "--statistics", "--stats", "-k", "--kmersize", "--index"
        ]
        filtered_extra = filter_xengsort_extra(args.xengsort_extra, used_params)
        cmd = (
            f"{args.xengsort_path} index "
            f"-H {args.host} "
            f"-G {args.graft} "
            f"-n {args.n} "
            f"--fill {args.fill} "
            f"--statistics {args.statistics} "
            f"-k {args.k} "
            f"--index {args.index} "
            f"{filtered_extra}"
        )
        print(f"[xengsort-index] CMD: {cmd}", file=sys.stdout)
        subprocess.check_call(cmd, shell=True)
    elif args.command == "xengsort-classify":
        run_xengsort_classify(args)
    elif args.command == "restore-fastq":
        restore_fastq_from_xengsort(args.read, args.out, args.read2, args.out2)
    elif args.command == "parse-xengsort-summary":
        parse_xengsort_summary_table(args.xengsort_summary, args.outfile)
    elif args.command == "parse-xengsort-log-table":
        parse_xengsort_summary_table(args.logfile, args.outfile)


if __name__ == "__main__":
    main()
